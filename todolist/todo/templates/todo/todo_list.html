<html>
  <head>
    <title>TODO 목록 앱</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
      :root {
        --color-primary: #4A90E2;    /* 기본 테마 색상 */
        --color-complete: #34C759;   /* 완료 버튼 색상 */
        --color-edit: #4A90E2;       /* 수정 버튼 색상 */
        --color-delete: #FF6B6B;     /* 삭제 버튼 색상 */
      }

      body {
        background-color: #f8f9fa;
      }
      .container {
        padding-top: 2rem;
      }
      .todo-info {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        flex-grow: 1;
      }
      .deadline {
        font-size: 0.9em;
        color: #666;
      }
      .important-stars {
        color: #ffd700;
      }
      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 0;
        border-bottom: 2px solid #eee;
      }
      .todo-details {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
      }
      .todo-details.show {
        display: block;
      }
      .detail-label {
        font-weight: bold;
        color: #666;
        margin-bottom: 5px;
      }
      .list-group-item {
        border: none;
        margin-bottom: 10px;
        border-radius: 8px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .list-group-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      .action-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;  /* 버튼들을 오른쪽으로 정렬 */
        padding-left: 15px;
      }
      .action-btn {
        padding: 4px 8px;
        font-size: 0.85em;
        border-radius: 6px;
        transition: all 0.2s ease;
        background-color: transparent;
      }
      .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .header-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .trash-btn {
        font-size: 1.2em;
        color: #666;
        transition: all 0.3s ease;
        text-decoration: none;
      }
      .trash-btn:hover {
        color: #333;
        text-decoration: none;
      }
      .add-todo-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        background-color: #fff;
        color: var(--color-primary);
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.3s ease;
        border-color: var(--color-primary);
      }
      .add-todo-btn:hover {
        background-color: var(--color-primary);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
      }
      .chevron-icon {
        transition: transform 0.3s ease;
      }
      .chevron-icon.rotated {
        transform: rotate(180deg);
      }
      .todo-container {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        padding-right: 10px;
        margin-top: 20px;
      }
      .todo-container::-webkit-scrollbar {
        width: 8px;
      }
      .todo-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      .todo-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .todo-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .action-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        transition: all 0.3s ease;
        text-decoration: none;
        border: 1px solid transparent;
      }
      .nav-btn:hover {
        transform: translateY(-1px);
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .done-btn {
        background-color: #fff;
        color: var(--color-complete);
        border-color: var(--color-complete);
      }
      .done-btn:hover {
        background-color: var(--color-complete);
        color: white;
      }
      .trash-btn {
        background-color: #fff;
        color: var(--color-delete);
        border-color: var(--color-delete);
      }
      .trash-btn:hover {
        background-color: var(--color-delete);
        color: white;
      }
      .sort-group {
        margin-bottom: 15px;
        display: flex;
        gap: 12px;
      }
      .sort-btn {
        color: #666;
        background-color: transparent;
        border: none;
        padding: 6px 12px;
        font-size: 0.9em;
        border-radius: 20px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .sort-btn:hover {
        color: var(--color-primary);
        background-color: rgba(74, 144, 226, 0.1);
      }
      .sort-btn.active {
        color: var(--color-primary);
        background-color: rgba(74, 144, 226, 0.15);
        font-weight: 500;
      }
      .sort-btn i {
        font-size: 1em;
      }
      .sort-btn.custom {
        background-color: #fff;
        color: #6610f2;
        border-color: #6610f2;
      }
      
      .sort-btn.custom:hover,
      .sort-btn.custom.active {
        background-color: #6610f2;
        color: white;
      }

      .todo-list-sortable .list-group-item {
        cursor: move;
      }

      .todo-list-sortable .list-group-item.sortable-ghost {
        opacity: 0.5;
        background: #f8f9fa;
      }

      .todo-list-sortable .list-group-item.sortable-drag {
        background: white;
      }

      .drag-handle {
        cursor: move;
        padding: 5px;
        margin-right: 10px;
        color: #adb5bd;
        visibility: hidden;
      }

      .list-group-item:hover .drag-handle {
        visibility: visible;
      }

      .container-fluid {
        padding: 2rem;
      }

      .main-content {
        display: flex;
        gap: 20px;
        transition: all 0.3s ease;
      }

      .todo-list-container {
        flex: 1;
        transition: all 0.3s ease;
      }

      .todo-list-container.with-details {
        flex: 0 0 60%;
      }

      .details-panel {
        flex: 0 0 38%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        display: none;
        animation: slideIn 0.3s ease;
      }

      .details-panel.show {
        display: block;
      }

      @keyframes slideIn {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
      }

      .sort-group {
        margin-bottom: 15px;
        display: flex;
        gap: 8px;
      }

      .todo-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .todo-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .bulk-actions {
        display: none;
        margin-bottom: 15px;
      }

      .bulk-actions.show {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .todo-arrow {
        margin-left: auto;
        color: #adb5bd;
        transition: all 0.3s ease;
      }

      .todo-arrow.rotated {
        transform: rotate(90deg);
      }

      .todo-main-content {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }

      .action-buttons {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .action-btn {
        padding: 4px 8px;
        font-size: 0.85em;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        transform: translateY(-1px);
      }

      .todo-arrow {
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.3s ease;
        color: var(--color-primary);
      }

      .todo-arrow:hover {
        background-color: rgba(74, 144, 226, 0.1);
      }

      .todo-content {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0 10px;
      }

      .list-group-item {
        padding: 12px 15px;
      }

      .todo-checkbox {
        margin-right: 5px;
      }

      .drag-handle {
        color: #dee2e6;
        padding: 0 5px;
      }

      .deadline {
        font-size: 0.85em;
        color: #6c757d;
      }

      .logout-btn {
        background-color: #fff;
        color: #dc3545;
        border-color: #dc3545;
      }
      .logout-btn:hover {
        background-color: #dc3545;
        color: white;
      }
    </style>
  </head>
  <body>
  <div class="container-fluid">
    <div class="header-container">
      <h1>TODO 목록 앱</h1>
      <div class="action-group">
          <a href="{% url 'todo_post' %}" class="add-todo-btn nav-btn">
              <i class="bi bi-plus-circle"></i> 새로운 TODO
          </a>
          <a href="{% url 'done_list' %}" class="done-btn nav-btn">
              <i class="bi bi-check2-circle"></i> 완료한 목록
          </a>
          <a href="{% url 'trash_list' %}" class="trash-btn nav-btn">
              <i class="bi bi-trash"></i> 휴지통
          </a>
          <form method="post" action="{% url 'logout' %}" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="nav-btn logout-btn">
                  <i class="bi bi-box-arrow-right"></i> 로그아웃
              </button>
          </form>
      </div>
  </div>
</div>
      </div>
    </div>

    <div class="sort-group">
      <button class="sort-btn" onclick="sortTodos(this, 'importance')">
        <i class="bi bi-star"></i> 중요도순
      </button>
      <button class="sort-btn" onclick="sortTodos(this, 'deadline')">
        <i class="bi bi-clock"></i> 마감일순
      </button>
      <button class="sort-btn" onclick="sortTodos(this, 'created')">
        <i class="bi bi-calendar"></i> 생성일순
      </button>
    </div>

    <div class="bulk-actions">
      <span class="selected-count">0개 선택됨</span>
      <button class="btn btn-danger btn-sm" onclick="bulkDelete()">
        <i class="bi bi-trash"></i> 선택 항목 삭제
      </button>
    </div>

    <div class="main-content">
      <div class="todo-list-container">
        <ul class="list-group todo-list-sortable">
          {% for todo in todos %}
          <li class="list-group-item" data-id="{{ todo.pk }}">
            <div class="todo-item">
              <input type="checkbox" class="todo-checkbox" onchange="handleCheckbox(this)">
              <i class="bi bi-grip-vertical drag-handle"></i>
              <div class="todo-content">
                <div class="todo-main-content">
                  <span class="todo-title">{{ todo.title }}</span>
                  {% if todo.important %}
                    <span class="important-stars">
                      {% for i in ''|ljust:todo.important %}★{% endfor %}
                    </span>
                  {% endif %}
                  {% if todo.deadline %}
                    <span class="deadline">
                      <i class="bi bi-clock"></i> 
                      {{ todo.deadline|date:"Y-m-d H:i" }}
                    </span>
                  {% endif %}
                </div>
                <div class="action-buttons">
                  <button onclick="location.href='{% url 'todo_done' pk=todo.pk %}'" 
                          class="action-btn btn btn-outline-success btn-sm" title="완료">
                    <i class="bi bi-check-lg"></i>
                  </button>
                  <button onclick="location.href='{% url 'todo_edit' pk=todo.pk %}'" 
                          class="action-btn btn btn-outline-primary btn-sm" title="수정">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button onclick="location.href='{% url 'todo_delete' pk=todo.pk %}'" 
                          class="action-btn btn btn-outline-danger btn-sm" title="삭제">
                    <i class="bi bi-trash"></i>
                  </button>
                  <i class="bi bi-chevron-right todo-arrow" onclick="showDetails('{{ todo.pk }}')"></i>
                </div>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>

      <div class="details-panel">
        <!-- 상세 정보가 여기에 동적으로 로드됩니다 -->
      </div>
    </div>
  </div>

  <script>
    // Sortable 초기화 (자동으로 활성화)
    const sortable = new Sortable(document.querySelector('.todo-list-sortable'), {
      animation: 150,
      handle: '.drag-handle',
      ghostClass: 'sortable-ghost',
      dragClass: 'sortable-drag',
      onEnd: function(evt) {
        const itemIds = Array.from(evt.target.children)
          .map(item => item.dataset.id);
        
        fetch('/todo/reorder/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ items: itemIds })
        });
      }
    });

    // 체크박스 처리
    function handleCheckbox(checkbox) {
      const bulkActions = document.querySelector('.bulk-actions');
      const checkboxes = document.querySelectorAll('.todo-checkbox:checked');
      const selectedCount = checkboxes.length;
      
      document.querySelector('.selected-count').textContent = 
        `${selectedCount}개 선택됨`;
      
      bulkActions.classList.toggle('show', selectedCount > 0);
    }

    // 선택 항목 일괄 삭제
    function bulkDelete() {
      const selectedIds = Array.from(document.querySelectorAll('.todo-checkbox:checked'))
        .map(checkbox => checkbox.closest('.list-group-item').dataset.id);
      
      if (confirm('선택한 항목을 모두 삭제하시겠습니까?')) {
        fetch('/todo/bulk-delete/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ items: selectedIds })
        }).then(() => {
          location.reload();
        });
      }
    }

    // 상세 정보 표시
    function showDetails(todoId) {
      const listContainer = document.querySelector('.todo-list-container');
      const detailsPanel = document.querySelector('.details-panel');
      const arrow = event.target;
      
      // 이미 열려있는 상세 정보 패널을 닫는 경우
      if (detailsPanel.classList.contains('show') && detailsPanel.dataset.todoId === todoId) {
        listContainer.classList.remove('with-details');
        detailsPanel.classList.remove('show');
        arrow.classList.remove('rotated');
        return;
      }

      // 로운 상세 정보 로드
      fetch(`/todo/detail/${todoId}/`)
        .then(response => response.json())
        .then(data => {
          detailsPanel.innerHTML = `
            <h3>${data.title}</h3>
            <div class="detail-content">
              <p><strong>설명:</strong><br>${data.description || '설명 없음'}</p>
              <p><strong>생성일:</strong><br>${data.created}</p>
              <p><strong>마감기��:</strong><br>${data.deadline || '없음'}</p>
              <p><strong>중요도:</strong><br>${'★'.repeat(data.important)}</p>
            </div>
          `;
          
          listContainer.classList.add('with-details');
          detailsPanel.classList.add('show');
          detailsPanel.dataset.todoId = todoId;
          
          // 모든 화살표 초기화 후 현재 화살표만 회전
          document.querySelectorAll('.todo-arrow').forEach(a => a.classList.remove('rotated'));
          arrow.classList.add('rotated');
        });
    }

    // CSRF 토큰 가져오기 함수
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function sortTodos(button, criterion) {
        // 모든 정렬 버튼의 active 클래스 제거
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 클릭된 버튼에 active 클래스 추가
        button.classList.add('active');
        
        // URL 파라미터 업데이트 및 페이지 리로드
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('sort', criterion);
        window.location.href = currentUrl.toString();
    }

    // 페이지 로드 시 현재 정렬 상태에 따라 버튼 활성화
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const currentSort = urlParams.get('sort');
        if (currentSort) {
            const activeButton = document.querySelector(`[onclick*="${currentSort}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
    });
  </script>
  </body>
</html>