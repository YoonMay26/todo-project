<html>
<head>
    <title>Quest ëª©ë¡</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js">
    <style>
<<<<<<< HEAD
        body {
            background-color: #f8f9fa;
            padding: 2rem;
=======
      :root {
        --color-primary: #4A90E2;    /* ê¸°ë³¸ í…Œë§ˆ ìƒ‰ìƒ */
        --color-complete: #34C759;   /* ì™„ë£Œ ë²„íŠ¼ ìƒ‰ìƒ */
        --color-edit: #4A90E2;       /* ìˆ˜ì • ë²„íŠ¼ ìƒ‰ìƒ */
        --color-delete: #FF6B6B;     /* ì‚­ì œ ë²„íŠ¼ ìƒ‰ìƒ */
      }

      body {
        background-color: #f8f9fa;
      }
      .container {
        padding-top: 2rem;
      }
      .todo-info {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        flex-grow: 1;
      }
      .deadline {
        font-size: 0.9em;
        color: #666;
      }
      .important-stars {
        color: #ffd700;
      }
      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 0;
        border-bottom: 2px solid #eee;
      }
      .todo-details {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
      }
      .todo-details.show {
        display: block;
      }
      .detail-label {
        font-weight: bold;
        color: #666;
        margin-bottom: 5px;
      }
      .list-group-item {
        border: none;
        margin-bottom: 10px;
        border-radius: 8px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .list-group-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      .action-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;  /* ë²„íŠ¼ë“¤ì„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì •ë ¬ */
        padding-left: 15px;
      }
      .action-btn {
        padding: 4px 8px;
        font-size: 0.85em;
        border-radius: 6px;
        transition: all 0.2s ease;
        background-color: transparent;
      }
      .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .header-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .trash-btn {
        font-size: 1.2em;
        color: #666;
        transition: all 0.3s ease;
        text-decoration: none;
      }
      .trash-btn:hover {
        color: #333;
        text-decoration: none;
      }
      .add-todo-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        background-color: #fff;
        color: var(--color-primary);
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.3s ease;
        border-color: var(--color-primary);
      }
      .add-todo-btn:hover {
        background-color: var(--color-primary);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
      }
      .chevron-icon {
        transition: transform 0.3s ease;
      }
      .chevron-icon.rotated {
        transform: rotate(180deg);
      }
      .todo-container {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        padding-right: 10px;
        margin-top: 20px;
      }
      .todo-container::-webkit-scrollbar {
        width: 8px;
      }
      .todo-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      .todo-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .todo-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .action-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        transition: all 0.3s ease;
        text-decoration: none;
        border: 1px solid transparent;
      }
      .nav-btn:hover {
        transform: translateY(-1px);
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .done-btn {
        background-color: #fff;
        color: var(--color-complete);
        border-color: var(--color-complete);
      }
      .done-btn:hover {
        background-color: var(--color-complete);
        color: white;
      }
      .trash-btn {
        background-color: #fff;
        color: var(--color-delete);
        border-color: var(--color-delete);
      }
      .trash-btn:hover {
        background-color: var(--color-delete);
        color: white;
      }
      .sort-group {
        margin-bottom: 15px;
        display: flex;
        gap: 12px;
      }
      .sort-btn {
        color: #666;
        background-color: transparent;
        border: none;
        padding: 6px 12px;
        font-size: 0.9em;
        border-radius: 20px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .sort-btn:hover {
        color: var(--color-primary);
        background-color: rgba(74, 144, 226, 0.1);
      }
      .sort-btn.active {
        color: var(--color-primary);
        background-color: rgba(74, 144, 226, 0.15);
        font-weight: 500;
      }
      .sort-btn i {
        font-size: 1em;
      }
      .sort-btn.custom {
        background-color: #fff;
        color: #6610f2;
        border-color: #6610f2;
      }
      
      .sort-btn.custom:hover,
      .sort-btn.custom.active {
        background-color: #6610f2;
        color: white;
      }

      .todo-list-sortable .list-group-item {
        cursor: move;
      }

      .todo-list-sortable .list-group-item.sortable-ghost {
        opacity: 0.5;
        background: #f8f9fa;
      }

      .todo-list-sortable .list-group-item.sortable-drag {
        background: white;
      }

      .drag-handle {
        cursor: move;
        padding: 5px;
        margin-right: 10px;
        color: #adb5bd;
        visibility: hidden;
      }

      .list-group-item:hover .drag-handle {
        visibility: visible;
      }

      .container-fluid {
        padding: 2rem;
      }

      .main-content {
        display: flex;
        gap: 20px;
        transition: all 0.3s ease;
      }

      .todo-list-container {
        flex: 1;
        transition: all 0.3s ease;
      }

      .todo-list-container.with-details {
        flex: 0 0 60%;
      }

      .details-panel {
        flex: 0 0 38%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        display: none;
        animation: slideIn 0.3s ease;
      }

      .details-panel.show {
        display: block;
      }

      @keyframes slideIn {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
      }

      .sort-group {
        margin-bottom: 15px;
        display: flex;
        gap: 8px;
      }

      .todo-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .todo-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .bulk-actions {
        display: none;
        margin-bottom: 15px;
      }

      .bulk-actions.show {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .todo-arrow {
        margin-left: auto;
        color: #adb5bd;
        transition: all 0.3s ease;
      }

      .todo-arrow.rotated {
        transform: rotate(90deg);
      }

      .todo-main-content {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }

      .action-buttons {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .action-btn {
        padding: 4px 8px;
        font-size: 0.85em;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .action-btn:hover {
        transform: translateY(-1px);
      }

      .todo-arrow {
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.3s ease;
        color: var(--color-primary);
      }

      .todo-arrow:hover {
        background-color: rgba(74, 144, 226, 0.1);
      }

      .todo-content {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0 10px;
      }

      .list-group-item {
        padding: 12px 15px;
      }

      .todo-checkbox {
        margin-right: 5px;
      }

      .drag-handle {
        color: #dee2e6;
        padding: 0 5px;
      }

      .deadline {
        font-size: 0.85em;
        color: #6c757d;
      }

      .logout-btn {
        background-color: #fff;
        color: #dc3545;
        border-color: #dc3545;
      }
      .logout-btn:hover {
        background-color: #dc3545;
        color: white;
      }
      .empty-message {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin: 2rem 0;
      }

      .empty-message p {
        color: #666;
        font-size: 1.2rem;
        margin: 1rem 0;
      }

      .empty-message .btn {
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        transition: all 0.3s ease;
      }

      .empty-message .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(74, 144, 226, 0.2);
      }

      .empty-message i {
        margin-bottom: 1rem;
      }

      .top-nav {
        display: flex;
        justify-content: flex-end;
        padding: 1rem 0;
        margin-bottom: 1rem;
        border-bottom: 1px solid #eee;
      }

      .logout-btn {
        padding: 8px 20px;
        border-radius: 20px;
        background: linear-gradient(135deg, #9b6b9d, #805d93);
        color: white;
        border: none;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(155, 107, 157, 0.2);
      }

      .logout-btn:hover {
        background: linear-gradient(135deg, #805d93, #9b6b9d);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(155, 107, 157, 0.3);
        color: white;
        text-decoration: none;
      }

      .logout-btn i {
        font-size: 1.1rem;
      }

      /* ê¸°ì¡´ í—¤ë” ì»¨í…Œì´ë„ˆ ë§ˆì§„ ìˆ˜ì • */
      .header-container {
        margin-bottom: 1.5rem;
      }

      .title-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-start;
      }

      .nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        border-radius: 20px;
        background-color: white;
        color: #4A90E2;
        border: 1px solid #4A90E2;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .nav-btn:hover {
        background-color: #4A90E2;
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
      }

      .header-container {
        margin-bottom: 2rem;
      }

      .title-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-start;
      }

      .nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        border-radius: 20px;
        background-color: white;
        color: #4A90E2;
        border: 1px solid #4A90E2;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .nav-btn:hover {
        background-color: #4A90E2;
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
      }

      .success-btn {
        color: #28a745;
        border-color: #28a745;
      }

      .success-btn:hover {
        background-color: #28a745;
        color: white;
      }

      .danger-btn {
        color: #dc3545;
        border-color: #dc3545;
      }

      .danger-btn:hover {
        background-color: #dc3545;
        color: white;
      }

      h1 {
        margin: 0;
        font-size: 1.8rem;
      }

      .primary-btn {
        background-color: #4A90E2;
        color: white;
      }

      .primary-btn:hover {
        background-color: #357ABD;
        color: white;
        transform: translateY(-2px);
      }

      .success-btn {
        background-color: #2ecc71;
        color: white;
      }

      .success-btn:hover {
        background-color: #27ae60;
        color: white;
        transform: translateY(-2px);
      }

      .danger-btn {
        background-color: #e74c3c;
        color: white;
      }

      .danger-btn:hover {
        background-color: #c0392b;
        color: white;
        transform: translateY(-2px);
      }

      .achievement-btn {
        background-color: #f1c40f;
        color: white;
      }

      .achievement-btn:hover {
        background-color: #f39c12;
        color: white;
        transform: translateY(-2px);
      }

      .logout-btn {
        background-color: #95a5a6;
        color: white;
      }

      .logout-btn:hover {
        background-color: #7f8c8d;
        color: white;
        transform: translateY(-2px);
      }

      /* ë²„íŠ¼ì— ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€ */
      .nav-btn {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .nav-btn:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }

      .header-container {
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-buttons {
        display: flex;
        gap: 8px;
      }

      .nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        border-radius: 20px;
        background-color: white;
        color: #666;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
        text-decoration: none;
        font-size: 0.95rem;
      }

      .nav-btn:hover {
        background-color: #f8f9fa;
        border-color: #666;
        color: #333;
        text-decoration: none;
        transform: translateY(-1px);
      }

      .nav-btn i {
        font-size: 1.1rem;
        transition: all 0.2s ease;
      }

      .nav-btn:hover i {
        transform: scale(1.1);
      }

      .top-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 1rem 0;
      }

      .top-buttons {
        display: flex;
        gap: 8px;
      }

      .nav-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-bottom: 1.5rem;
      }

      h1 {
        margin: 0;
        font-size: 1.8rem;
        color: #333;
      }

      .nav-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        border-radius: 20px;
        background-color: white;
        color: #666;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
        text-decoration: none;
        font-size: 0.95rem;
      }

      .nav-btn:hover {
        background-color: #f8f9fa;
        border-color: #666;
        color: #333;
        text-decoration: none;
        transform: translateY(-1px);
      }

      .nav-btn i {
        font-size: 1.1rem;
        transition: all 0.2s ease;
      }

      .nav-btn:hover i {
        transform: scale(1.1);
      }
    </style>
  </head>
  <body>
  <div class="container-fluid">
    <div class="top-nav">
      <h1>ë‚˜ì˜ Quest ëª©ë¡</h1>
      <div class="top-buttons">
        <a href="{% url 'todo_stats' %}" class="nav-btn">
          <i class="bi bi-trophy" style="color: #f39c12;"></i> Achievement
        </a>
        <a href="{% url 'logout' %}" class="nav-btn">
          <i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ
        </a>
      </div>
    </div>
    <div class="nav-buttons">
      <a href="{% url 'todo_post' %}" class="nav-btn">
        <i class="bi bi-plus-circle-fill" style="color: #4A90E2;"></i> ìƒˆ Quest
      </a>
      <a href="{% url 'done_list' %}" class="nav-btn">
        <i class="bi bi-check-circle" style="color: #28a745;"></i> ì™„ë£Œí•œ Quest
      </a>
      <a href="{% url 'trash_list' %}" class="nav-btn">
        <i class="bi bi-trash" style="color: #dc3545;"></i> ë¯¸ìˆ˜ë½ Quest
      </a>
    </div>
  </div>

  <div class="sort-group">
    <button class="sort-btn" onclick="sortTodos(this, 'importance')">
      <i class="bi bi-star"></i> ì¤‘ìš”ë„ìˆœ
    </button>
    <button class="sort-btn" onclick="sortTodos(this, 'deadline')">
      <i class="bi bi-clock"></i> ë§ˆê°ì¼ìˆœ
    </button>
    <button class="sort-btn" onclick="sortTodos(this, 'created')">
      <i class="bi bi-calendar"></i> ìƒì„±ì¼ìˆœ
    </button>
  </div>

  <div class="bulk-actions">
    <span class="selected-count">0ê°œ ì„ íƒë¨</span>
    <button class="btn btn-danger btn-sm" onclick="bulkDelete()">
      <i class="bi bi-trash"></i> ì„ íƒ í•­ëª© ì‚­ì œ
    </button>
  </div>

  <div class="main-content">
    <div class="todo-list-container">
      {% if todos %}
      <ul class="list-group" id="todo-list">
          {% for todo in todos %}
          <li class="list-group-item" data-id="{{ todo.pk }}">
              <div class="todo-item">
                  <input type="checkbox" class="todo-checkbox" onchange="handleCheckbox(this)">
                  <i class="bi bi-grip-vertical drag-handle"></i>
                  <div class="todo-content">
                      <div class="todo-main-content">
                          <span class="todo-title">{{ todo.title }}</span>
                          {% if todo.important %}
                              <span class="important-stars">
                                  {% for i in ''|ljust:todo.important %}â˜…{% endfor %}
                              </span>
                          {% endif %}
                          {% if todo.deadline %}
                              <span class="deadline">
                                  <i class="bi bi-clock"></i> 
                                  {{ todo.deadline|date:"Y-m-d H:i" }}
                              </span>
                          {% endif %}
                      </div>
                      <div class="action-buttons">
                          <button onclick="location.href='{% url 'todo_done' pk=todo.pk %}'" 
                                  class="action-btn btn btn-outline-success btn-sm" title="ì™„ë£Œ">
                              <i class="bi bi-check-lg"></i>
                          </button>
                          <button onclick="location.href='{% url 'todo_edit' pk=todo.pk %}'" 
                                  class="action-btn btn btn-outline-primary btn-sm" title="ìˆ˜ì •">
                              <i class="bi bi-pencil"></i>
                          </button>
                          <button onclick="location.href='{% url 'todo_delete' pk=todo.pk %}'" 
                                  class="action-btn btn btn-outline-danger btn-sm" title="ì‚­ì œ">
                              <i class="bi bi-trash"></i>
                          </button>
                          <i class="bi bi-chevron-right todo-arrow" onclick="showDetails('{{ todo.pk }}')"></i>
                      </div>
                  </div>
              </div>
          </li>
          {% endfor %}
      </ul>
      {% else %}
      <div class="empty-message">
          <i class="bi bi-journal-plus" style="font-size: 2rem; color: #4A90E2;"></i>
          <p class="mt-3">ìƒˆë¡œìš´ Questë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
          <button onclick="location.href='{% url 'todo_post' %}'" 
                  class="btn btn-outline-primary mt-2">
              <i class="bi bi-plus-lg"></i> ìƒˆë¡œìš´ Quest ì¶”ê°€í•˜ê¸°
          </button>
      </div>
      {% endif %}
    </div>

    <div class="details-panel">
      <!-- ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
    </div>
  </div>
</div>

  <script>
    // Sortable ì´ˆê¸°í™” (ìë™ìœ¼ë¡œ í™œì„±í™”)
    const sortable = new Sortable(document.querySelector('.todo-list-sortable'), {
      animation: 150,
      handle: '.drag-handle',
      ghostClass: 'sortable-ghost',
      dragClass: 'sortable-drag',
      onEnd: function(evt) {
        const itemIds = Array.from(evt.target.children)
          .map(item => item.dataset.id);
        
        fetch('/todo/reorder/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ items: itemIds })
        });
      }
    });

    // ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
    function handleCheckbox(checkbox) {
      const bulkActions = document.querySelector('.bulk-actions');
      const checkboxes = document.querySelectorAll('.todo-checkbox:checked');
      const selectedCount = checkboxes.length;
      
      document.querySelector('.selected-count').textContent = 
        `${selectedCount}ê°œ ì„ íƒë¨`;
      
      bulkActions.classList.toggle('show', selectedCount > 0);
    }

    // ì„ íƒ í•­ëª© ì¼ê´„ ì‚­ì œ
    function bulkDelete() {
      const selectedIds = Array.from(document.querySelectorAll('.todo-checkbox:checked'))
        .map(checkbox => checkbox.closest('.list-group-item').dataset.id);
      
      if (confirm('ì„ íƒí•œ í•­ëª©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch('/todo/bulk-delete/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ items: selectedIds })
        }).then(() => {
          location.reload();
        });
      }
    }

    // ìƒì„¸ ì •ë³´ í‘œì‹œ
    function showDetails(todoId) {
      const listContainer = document.querySelector('.todo-list-container');
      const detailsPanel = document.querySelector('.details-panel');
      const arrow = event.target;
      
      // ì´ë¯¸ ì—´ë ¤ìˆëŠ” ìƒì„¸ ì •ë³´ íŒ¨ë„ì„ ë‹«ëŠ” ê²½ìš°
      if (detailsPanel.classList.contains('show') && detailsPanel.dataset.todoId === todoId) {
        listContainer.classList.remove('with-details');
        detailsPanel.classList.remove('show');
        arrow.classList.remove('rotated');
        return;
      }

      // ë¡œìš´ ìƒì„¸ ì •ë³´ ë¡œë“œ
      fetch(`/todo/detail/${todoId}/`)
        .then(response => response.json())
        .then(data => {
          detailsPanel.innerHTML = `
            <h3>${data.title}</h3>
            <div class="detail-content">
              <p><strong>ì„¤ëª…:</strong><br>${data.description || 'ì„¤ëª… ì—†ìŒ'}</p>
              <p><strong>ìƒì„±ì¼:</strong><br>${data.created}</p>
              <p><strong>ë§ˆê°ê¸°í•œ:</strong><br>${data.deadline || 'ì—†ìŒ'}</p>
              <p><strong>ì¤‘ìš”ë„:</strong><br>${'â˜…'.repeat(data.important)}</p>
            </div>
          `;
          
          listContainer.classList.add('with-details');
          detailsPanel.classList.add('show');
          detailsPanel.dataset.todoId = todoId;
          
          // ëª¨ë“  í™”ì‚´í‘œ ì´ˆê¸°í™” í›„ í˜„ì¬ í™”ì‚´í‘œë§Œ íšŒì „
          document.querySelectorAll('.todo-arrow').forEach(a => a.classList.remove('rotated'));
          arrow.classList.add('rotated');
        });
    }

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
>>>>>>> 983a0fe7e34f6a3db90db8172711a271c648eaf1
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .top-nav {
            background: white;
            padding: 1rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .profile-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: fit-content;
            transition: box-shadow 0.5s ease-out;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .profile-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #2d3436;
        }

        .settings-btn {
            color: #b2bec3;
            transition: color 0.3s ease;
        }

        .settings-btn:hover {
            color: #636e72;
        }

        .profile-content {
            text-align: center;
        }

        .character-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin-bottom: 1rem;
            object-fit: cover;
            border: 3px solid #6c5ce7;
        }

        .profile-info {
            color: #2d3436;
        }

        .level {
            font-size: 1.1rem;
            font-weight: bold;
            color: #6c5ce7;
            margin: 0.5rem 0;
        }

        .title {
            font-size: 0.9rem;
            color: #636e72;
            margin: 0;
        }

        .quest-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .sort-buttons {
            display: flex;
            gap: 8px;
        }

        .sort-button {
            padding: 6px 12px;
            border: none;
            background: none;
            color: #666;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sort-button:hover, .sort-button.active {
            background-color: #f1f3f5;
            color: #333;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            border-radius: 20px;
            background-color: white;
            color: #666;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .nav-btn:hover {
            background-color: #f8f9fa;
            border-color: #666;
            color: #333;
            transform: translateY(-1px);
        }

        .list-group-item {
            border: none;
            margin-bottom: 10px;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .list-group-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .todo-content {
            padding: 10px;
            width: 100%;
        }

        .todo-main-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .important-stars {
            color: #ffd700;
            font-size: 0.9em;
        }

        .deadline {
            font-size: 0.85em;
            color: #666;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            font-size: 0.85em;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .todo-details {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideDown 0.3s ease;
        }

        .todo-arrow {
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .todo-arrow.rotated {
            transform: rotate(90deg);
        }

        .list-group-item {
            cursor: grab;
        }

        .list-group-item:active {
            cursor: grabbing;
        }

        .sortable-ghost {
            opacity: 0.5;
            background: #f0f0f0;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .selection-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .select-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            border-radius: 20px;
            background-color: white;
            color: #6c5ce7;
            border: 1px solid #6c5ce7;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .select-btn:hover {
            background-color: #6c5ce7;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(108, 92, 231, 0.2);
        }

        .select-btn.active {
            background-color: #6c5ce7;
            color: white;
        }

        .delete-select-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            border-radius: 20px;
            background-color: white;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .delete-select-btn:hover {
            background-color: #e74c3c;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
        }

        .todo-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #6c5ce7;
        }

        @keyframes levelUpGlow {
            0% { box-shadow: 0 0 10px #6c5ce7; }
            50% { box-shadow: 0 0 20px #6c5ce7, 0 0 30px #6c5ce7; }
            100% { box-shadow: 0 0 10px #6c5ce7; }
        }
        
        .level-up-animation {
            animation: levelUpGlow 1s ease-in-out;
        }
        
        .level-up-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(108, 92, 231, 0.95);
            color: white;
            padding: 25px 50px;
            border-radius: 15px;
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .level-up-message button {
            margin-top: 10px;
            padding: 5px 20px;
            font-size: 1rem;
        }
        
        .level-up-message.show {
            opacity: 1;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Top Navigation -->
        <div class="top-nav">
            <h1>ë‚˜ì˜ Quest ëª©ë¡</h1>
            <div class="top-buttons">
                <a href="{% url 'profile' %}" class="nav-btn">
                    <i class="bi bi-person-circle" style="color: #6c5ce7;"></i> Profile
                </a>
                <a href="{% url 'todo_stats' %}" class="nav-btn">
                    <i class="bi bi-trophy" style="color: #f39c12;"></i> Achievement
                </a>
                <a href="{% url 'logout' %}" class="nav-btn">
                    <i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Profile Card -->
            <div class="profile-card">
                <div class="profile-header">
                    <h3>{{ user.nickname }}</h3>
                    <a href="{% url 'profile_edit' %}" class="settings-btn">
                        <i class="bi bi-gear"></i>
                    </a>
                </div>
                <div class="profile-content">
                    <img src="{{ user.character_image }}" alt="ìºë¦­í„°" class="character-image">
                    <div class="profile-info">
                        <p class="level">Lv. {{ user_stats.level }}</p>
                        <p class="title">{{ user_stats.title }}</p>
                        <p class="completed-count">ì™„ë£Œí•œ Quest: {{ user_stats.completed_count }}ê°œ</p>
                    </div>
                </div>
            </div>

            <!-- Quest List -->
            <div class="quest-container">
                <div class="list-header">
                    <div class="sort-buttons">
                        <button class="sort-button {% if sort == 'importance' %}active{% endif %}" 
                                onclick="location.href='?sort=importance'">
                            <i class="bi bi-star-fill"></i> ì¤‘ìš”ë„ìˆœ
                        </button>
                        <button class="sort-button {% if sort == 'deadline' %}active{% endif %}" 
                                onclick="location.href='?sort=deadline'">
                            <i class="bi bi-calendar"></i> ë§ˆê°ì¼ìˆœ
                        </button>
                        <button class="sort-button {% if sort == 'created' %}active{% endif %}" 
                                onclick="location.href='?sort=created'">
                            <i class="bi bi-clock"></i> ë“±ë¡ì¼ìˆœ
                        </button>
                    </div>
                    <div class="nav-buttons">
                        <a href="{% url 'todo_post' %}" class="nav-btn">
                            <i class="bi bi-plus-circle-fill" style="color: #4A90E2;"></i> ìƒˆ Quest
                        </a>
                        <a href="{% url 'done_list' %}" class="nav-btn">
                            <i class="bi bi-check-circle" style="color: #28a745;"></i> ì™„ë£Œí•œ Quest
                        </a>
                        <a href="{% url 'trash_list' %}" class="nav-btn">
                            <i class="bi bi-trash" style="color: #dc3545;"></i> ë¯¸ìˆ˜ë½ Quest
                        </a>
                    </div>
                </div>

                <!-- Todo List -->
                <div class="todo-list">
                    <div class="list-group">
                        <div class="list-header mb-3">
                            <div class="selection-buttons">
                                <button id="selectAllBtn" class="select-btn">
                                    <i class="bi bi-check-square"></i> ì „ì²´ ì„ íƒ
                                </button>
                                <button id="deleteSelectedBtn" class="delete-select-btn" style="display: none;">
                                    <i class="bi bi-trash"></i> ì„ íƒ ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        
                        {% if todos %}
                        <ul class="list-group" id="sortable-list">
                            {% for todo in todos %}
                            <li class="list-group-item" data-id="{{ todo.pk }}">
                                <div class="todo-content">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="todo-main-content">
                                            <input type="checkbox" class="todo-checkbox mr-2" data-id="{{ todo.pk }}">
                                            <span class="todo-title">{{ todo.title }}</span>
                                            {% if todo.important %}
                                            <span class="important-stars">
                                                {% for i in ''|ljust:todo.important %}â˜…{% endfor %}
                                            </span>
                                            {% endif %}
                                            {% if todo.deadline %}
                                            <span class="deadline">
                                                <i class="bi bi-clock"></i> {{ todo.deadline|date:"Y-m-d H:i" }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div class="action-buttons">
                                            <a href="{% url 'todo_edit' pk=todo.pk %}" class="action-btn btn btn-outline-primary btn-sm">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button onclick="toggleComplete({{ todo.pk }})" class="action-btn btn btn-outline-success btn-sm">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button onclick="location.href='{% url 'todo_delete' pk=todo.pk %}'" class="action-btn btn btn-outline-danger btn-sm">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            <i class="bi bi-chevron-right todo-arrow" onclick="showDetails('{{ todo.pk }}')"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="todo-details" style="display: none;">
                                    <div class="details-content">
                                        <p><strong>ì„¤ëª…:</strong><br>{{ todo.description|default:"ì„¤ëª… ì—†ìŒ" }}</p>
                                        <p><strong>ìƒì„±ì¼:</strong><br>{{ todo.created|date:"Y-m-d H:i" }}</p>
                                        <p><strong>ë§ˆê°ê¸°í•œ:</strong><br>{{ todo.deadline|date:"Y-m-d H:i"|default:"ì—†ìŒ" }}</p>
                                        <p><strong>ì¤‘ìš”ë„:</strong><br>{{ todo.important|default:"0" }} / 5</p>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if user_stats.is_level_up %}
    <div id="levelUpMessage" class="level-up-message">
        ğŸ‰ Level Up! ğŸ‰<br>
        Lv.{{ user_stats.level }} {{ user_stats.title }}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // í”„ë¡œí•„ ì¹´ë“œì— ë°˜ì§ì´ëŠ” íš¨ê³¼ ì¶”ê°€
        const profileCard = document.querySelector('.profile-card');
        profileCard.classList.add('level-up-animation');
        
        // ë ˆë²¨ì—… ë©”ì‹œì§€ í‘œì‹œ
        const levelUpMessage = document.getElementById('levelUpMessage');
        levelUpMessage.classList.add('show');
        
        // ê½ƒê°€ë£¨ íš¨ê³¼
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
        
        // ì¶”ê°€ ê½ƒê°€ë£¨ íš¨ê³¼ (ì–‘ìª½ì—ì„œ)
        confetti({
            particleCount: 50,
            angle: 60,
            spread: 55,
            origin: { x: 0 }
        });
        confetti({
            particleCount: 50,
            angle: 120,
            spread: 55,
            origin: { x: 1 }
        });
        
        // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        setTimeout(() => {
            levelUpMessage.classList.remove('show');
        }, 3000);
    });
    </script>
    {% endif %}

    <script>
        function toggleComplete(todoId) {
            fetch(`/todo/done/${todoId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸
                    document.querySelector('.level').textContent = `Lv. ${data.new_level}`;
                    document.querySelector('.title').textContent = data.new_title;
                    document.querySelector('.completed-count').textContent = `ì™„ë£Œí•œ Quest: ${data.completed_count}ê°œ`;
                    
                    // Quest í•­ëª© ì œê±°
                    const todoItem = document.querySelector(`li[data-id="${todoId}"]`);
                    if (todoItem) {
                        todoItem.remove();
                    }
                    
                    // ë ˆë²¨ì—… í–ˆë‹¤ë©´ ì¶•í•˜ íš¨ê³¼ í‘œì‹œ
                    if (data.is_level_up) {
                        // confetti ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                        if (typeof confetti === 'function') {
                            showLevelUpCelebration(data.new_level, data.new_title);
                        } else {
                            // confetti ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë“œ
                            const script = document.createElement('script');
                            script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js';
                            script.onload = function() {
                                showLevelUpCelebration(data.new_level, data.new_title);
                            };
                            document.head.appendChild(script);
                        }
                    }
                }
            });
        }

        function showLevelUpCelebration(level, title) {
            // ë ˆë²¨ì—… ë©”ì‹œì§€ ìƒì„±
            const messageDiv = document.createElement('div');
            messageDiv.id = 'levelUpMessage';
            messageDiv.className = 'level-up-message';
            messageDiv.innerHTML = `
                ğŸ‰ Level Up! ğŸ‰<br>
                Lv.${level} ${title}<br><br>
                <button class="btn btn-light btn-sm" onclick="removeCelebrationEffects()">ì‹ ë‚œë‹¤!</button>
            `;
            document.body.appendChild(messageDiv);
            
            // í”„ë¡œí•„ ì¹´ë“œì— ë°˜ì§ì´ëŠ” íš¨ê³¼ ì¶”ê°€
            const profileCard = document.querySelector('.profile-card');
            profileCard.classList.add('level-up-animation');
            
            // ë©”ì‹œì§€ í‘œì‹œ
            requestAnimationFrame(() => {
                messageDiv.classList.add('show');
            });
            
            // í™”ë ¤í•œ ê½ƒê°€ë£¨ íš¨ê³¼ ì‹œì‘
            // 1. ì¤‘ì•™ í­ë°œ
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }
            });
            
            // 2. ì–‘ìª½ì—ì„œ ì—°ì†ìœ¼ë¡œ ë‚˜ì˜¤ëŠ” ê½ƒê°€ë£¨
            window.confettiInterval = setInterval(() => {
                // ì™¼ìª½
                confetti({
                    particleCount: 3,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#6c5ce7', '#a8e6cf', '#dcedc1', '#ffd3b6', '#ffaaa5', '#ff7675', '#74b9ff'],
                    scalar: 2
                });
                
                // ì˜¤ë¥¸ìª½
                confetti({
                    particleCount: 3,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#6c5ce7', '#a8e6cf', '#dcedc1', '#ffd3b6', '#ffaaa5', '#ff7675', '#74b9ff'],
                    scalar: 2
                });
            }, 50);

            // 3. ì¶”ê°€ ëœë¤ í­ë°œ íš¨ê³¼
            let explosionCount = 0;
            window.explosionInterval = setInterval(() => {
                if (explosionCount < 3) {  // 3ë²ˆì˜ ì¶”ê°€ í­ë°œ
                    confetti({
                        particleCount: 50,
                        spread: 120,
                        origin: { 
                            x: Math.random() * 0.8 + 0.1, 
                            y: Math.random() * 0.3 + 0.4 
                        },
                        colors: ['#6c5ce7', '#a8e6cf', '#dcedc1', '#ffd3b6', '#ffaaa5', '#ff7675', '#74b9ff'],
                        scalar: 1.5
                    });
                    explosionCount++;
                } else {
                    clearInterval(window.explosionInterval);
                }
            }, 500);
        }

        function removeCelebrationEffects() {
            // ëª¨ë“  ê½ƒê°€ë£¨ íš¨ê³¼ ì¤‘ì§€
            if (window.confettiInterval) {
                clearInterval(window.confettiInterval);
            }
            if (window.explosionInterval) {
                clearInterval(window.explosionInterval);
            }
            
            // ë©”ì‹œì§€ ì œê±°
            const messageDiv = document.getElementById('levelUpMessage');
            if (messageDiv) {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }
            
            // í”„ë¡œí•„ ì¹´ë“œ íš¨ê³¼ ì œê±°
            const profileCard = document.querySelector('.profile-card');
            if (profileCard) {
                profileCard.classList.remove('level-up-animation');
            }
        }

        // Sortable ì´ˆê¸°í™”
        new Sortable(document.getElementById('sortable-list'), {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function(evt) {
                const itemId = evt.item.dataset.id;
                const newIndex = evt.newIndex;
                
                fetch('/todo/reorder/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        id: itemId,
                        order: newIndex
                    })
                });
            }
        });

        // ìƒì„¸ ì •ë³´ í† ê¸€
        function showDetails(todoId) {
            const detailsDiv = document.querySelector(`li[data-id="${todoId}"] .todo-details`);
            const arrow = document.querySelector(`li[data-id="${todoId}"] .todo-arrow`);
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                arrow.classList.add('rotated');
            } else {
                detailsDiv.style.display = 'none';
                arrow.classList.remove('rotated');
            }
        }

        // ì²´í¬ë°•ìŠ¤ ê´€ë ¨ ê¸°ëŠ¥
        $(document).ready(function() {
            const $selectAllBtn = $('#selectAllBtn');
            const $deleteSelectedBtn = $('#deleteSelectedBtn');
            const $checkboxes = $('.todo-checkbox');

            // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
            const csrftoken = document.querySelector('[name=csrf-token]').content;

            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ ì‹œ
            $(document).on('change', '.todo-checkbox', function() {
                const checkedCount = $('.todo-checkbox:checked').length;
                $deleteSelectedBtn.toggle(checkedCount > 0);
            });

            // ì „ì²´ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ
            $selectAllBtn.click(function() {
                const isChecked = $(this).hasClass('active');
                $checkboxes.prop('checked', !isChecked);
                $(this).toggleClass('active');
                $deleteSelectedBtn.toggle(!isChecked && $checkboxes.length > 0);
            });

            // ì„ íƒ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
            $deleteSelectedBtn.click(function() {
                const selectedIds = [];
                $('.todo-checkbox:checked').each(function() {
                    selectedIds.push($(this).closest('li').data('id'));
                });

                if (selectedIds.length > 0) {
                    $.ajax({
                        url: "{% url 'todo_delete_multiple' %}",
                        type: 'POST',
                        data: JSON.stringify({ ids: selectedIds }),
                        contentType: 'application/json',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            if (response.status === 'success') {
                                location.reload();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error:', error);
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>